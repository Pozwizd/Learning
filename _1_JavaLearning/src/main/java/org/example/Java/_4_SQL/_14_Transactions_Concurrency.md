# 14. Транзакции и Конкурентный доступ (Transactions & Concurrency)

## Транзакция
Последовательность операций, которая воспринимается базой данных как единое целое.

### Управление транзакциями
*   `BEGIN TRANSACTION` / `START TRANSACTION`: Начало.
*   `COMMIT`: Фиксация изменений (сохранение).
*   `ROLLBACK`: Отмена изменений (возврат к состоянию до начала).
*   `SAVEPOINT name`: Точка сохранения внутри транзакции, к которой можно откатиться (`ROLLBACK TO name`).

```sql
BEGIN;
UPDATE Accounts SET Balance = Balance - 100 WHERE ID = 1;
UPDATE Accounts SET Balance = Balance + 100 WHERE ID = 2;
-- Если здесь произойдет ошибка, можно сделать ROLLBACK
COMMIT;
```

## Уровни изоляции (Isolation Levels)
Определяют, как транзакции видят изменения друг друга.

### Проблемы параллелизма
1.  **Dirty Read (Грязное чтение)**: Чтение данных, которые еще не закоммичены другой транзакцией.
2.  **Non-repeatable Read (Неповторяющееся чтение)**: Повторный запрос в той же транзакции возвращает другие данные (кто-то изменил строку).
3.  **Phantom Read (Фантомное чтение)**: Повторный запрос возвращает новые строки (кто-то добавил данные).

### Уровни (от слабого к сильному)
1.  **READ UNCOMMITTED**: Видит незакоммиченные изменения. Возможны все проблемы. Самый быстрый, но опасный.
2.  **READ COMMITTED** (Default в Postgres, Oracle, SQL Server): Видит только закоммиченные данные. Защищает от Dirty Read.
3.  **REPEATABLE READ** (Default в MySQL): Гарантирует, что если вы прочитали строку, она не изменится до конца транзакции. Защищает от Dirty и Non-repeatable Read.
4.  **SERIALIZABLE**: Полная изоляция. Транзакции выполняются так, будто они идут последовательно. Защищает от всего, но самый медленный (много блокировок).

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

## Блокировки (Locks)
*   **Shared Lock (S)**: Для чтения. Другие могут читать, но не писать.
*   **Exclusive Lock (X)**: Для записи. Никто не может ни читать, ни писать.
*   **Deadlock (Взаимная блокировка)**: Транзакция А ждет ресурс Б, а Транзакция Б ждет ресурс А. СУБД обычно сама находит и убивает одну из транзакций.
